"use strict";(self.webpackChunkklerk_website=self.webpackChunkklerk_website||[]).push([[9989],{3521:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>s,metadata:()=>a,toc:()=>c});var i=t(4848),o=t(8453);const s={sidebar_position:4},r="DSL and functions",a={id:"building-config/pure-functions",title:"DSL and functions",description:"In Klerk, you use the Domain Specific Language (DSL) to define your system at a high level and then implement the details through pure functions. These functions are called by the framework at the appropriate times to enforce the behavior you've specified.",source:"@site/docs/building-config/pure-functions.md",sourceDirName:"building-config",slug:"/building-config/pure-functions",permalink:"/docs/building-config/pure-functions",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Collections",permalink:"/docs/building-config/collections"},next:{title:"Models and Types",permalink:"/docs/building-config/models-types"}},l={},c=[{value:"Pure functions",id:"pure-functions",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"dsl-and-functions",children:"DSL and functions"}),"\n",(0,i.jsx)(n.p,{children:"In Klerk, you use the Domain Specific Language (DSL) to define your system at a high level and then implement the details through pure functions. These functions are called by the framework at the appropriate times to enforce the behavior you've specified."}),"\n",(0,i.jsx)(n.p,{children:"For example, if you want generals to be allowed to read secret reports, you would define a rule using both the DSL and a pure function:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"val config = ConfigBuilder<Ctx, Data>(collections).build {\n    authentication {\n       readModel {\n          positive {\n             rule(::generalsCanReadSecretReports)\n          }\n       }\n       ...\n    }\n}\n\nfun generalsCanReadSecretReports(args: ArgContextReader<Ctx, Data>): PositiveAuthorization {\n    if (args.model !is Report || args.model.classification != Secret) {\n        return NoOpinion\n    }\n    return if (args.context.user.rank == General) Allow else NoOpinion\n}\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsxs)(n.p,{children:["Design the system from the top down. Start by outlining the big pieces, leaving the details for later.\nIn Klerk, this means beginning with the DSL. Only turn your attention to the functions when you are satisfied with the specification.\nWhile you will need to create the function signatures for inclusion in the DSL, you can initially leave the function bodies empty by using ",(0,i.jsx)(n.code,{children:"TODO()"})," placeholders."]}),(0,i.jsxs)(n.p,{children:["Klerk provides limited functionality even when the function bodies are empty. It is not possible\nto read data and issue commands, but it ",(0,i.jsx)(n.em,{children:"is"})," possible to view the generated documentation in the Admin UI.\nTake advantage of this: use the state diagrams to make sure the specification is accepted by all stakeholders before writing any code in the function bodies."]}),(0,i.jsx)(n.p,{children:"Since writing the function bodies and the corresponding unit tests is often straightforward, these tasks can be suitable for junior developers."})]}),"\n",(0,i.jsx)(n.h2,{id:"pure-functions",children:"Pure functions"}),"\n",(0,i.jsxs)(n.p,{children:["These functions should be ",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Pure_function",children:"pure"}),", which means:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"the function's return value is identical for identical arguments"}),"\n",(0,i.jsx)(n.li,{children:"the function has no side effect"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["It is acceptable to use ",(0,i.jsx)(n.code,{children:"require()"}),", ",(0,i.jsx)(n.code,{children:"requireNonNull()"})," or similar even though they can throw ",(0,i.jsx)(n.code,{children:"IllegalArgumentException"})," which\nmakes the\nfunction impure. Note that the function should never actually throw, so you should only use them if you know that they\nwill not throw. If your function actually throws, this means that the system has a bug! The bug may not\nnecessarily reside in the function that throws. To exemplify: Suppose your an event triggers an update of a model. The\nupdate function will return a new model that contains the logged in user's ID in the property ",(0,i.jsx)(n.code,{children:"acceptedByUsers"}),". You\nknow that the update can only be triggered by an logged in user since you have added a validation rule on the triggering\nevent, so it is safe to have"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"requireNonNull(args.context.loggedInUser)\n"})}),"\n",(0,i.jsx)(n.p,{children:"in the update function. If the update function ever\nthrows an exception, you have a bug and need to figure out how context.loggedInUser could be null when\nthe update was triggered."}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"Don't worry about remembering which parameters a function should take and what the return\ntype should be. The IDE will help you! First tell Klerk about the function in the DSL, then ask the IDE to generate the function for you. In IntelliJ, use Alt+enter to bring up the context actions."})})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var i=t(6540);const o={},s=i.createContext(o);function r(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);