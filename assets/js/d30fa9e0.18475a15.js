"use strict";(self.webpackChunkklerk_website=self.webpackChunkklerk_website||[]).push([[3959],{1536:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var s=n(4848),i=n(8453);const o={sidebar_position:2},r="Context",a={id:"building-config/context",title:"Context",description:"In all interaction with Klerk you must supply a context. As an example:",source:"@site/docs/building-config/context.md",sourceDirName:"building-config",slug:"/building-config/context",permalink:"/docs/building-config/context",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Overview",permalink:"/docs/building-config/overview"},next:{title:"Collections",permalink:"/docs/building-config/collections"}},l={},c=[{value:"Actor",id:"actor",level:2},{value:"Systems with a &#39;User&#39; concept",id:"systems-with-a-user-concept",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"context",children:"Context"}),"\n",(0,s.jsx)(t.p,{children:"In all interaction with Klerk you must supply a context. As an example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"val myReport = klerk.read(context) { get(myReportId) }\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The most important piece in a context\nis ",(0,s.jsx)(t.code,{children:"actor"}),", which specifies on whose behalf the interaction occurs (usually a logged-in user)."]}),"\n",(0,s.jsx)(t.p,{children:"The context will be included in the parameters in many of the functions you provide to Klerk. As an\nexample,\nto declare a rule that generals can read secret reports, you will create a function that looks something like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"fun generalsCanReadSecretReports(args: ArgContextReader<Ctx, Data>): PositiveAuthorization {\n    if (args.model !is Report || args.model.classification != Secret) {\n        return NoOpinion\n    }\n    return if (args.context.user.rank == General) Allow else NoOpinion\n}\n"})}),"\n",(0,s.jsxs)(t.p,{children:['It is recommended to name the context class "Ctx" but you are free to call it whatever you like. The class must\nimplement the ',(0,s.jsx)(t.code,{children:"KlerkContext"})," interface."]}),"\n",(0,s.jsxs)(t.admonition,{type:"tip",children:[(0,s.jsx)(t.p,{children:"If you are eager to get started, just copy this into your code:"}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"class Ctx(\n    override val actor: ActorIdentity,\n    override val auditExtra: String? = null,\n    override val time: Instant = Clock.System.now(),\n    override val translator: Translator = DefaultTranslator(),\n) : KlerkContext\n"})}),(0,s.jsxs)(t.p,{children:["Whenever you need a context, just do ",(0,s.jsx)(t.code,{children:"Ctx(Unauthenticated)"})]}),(0,s.jsx)(t.p,{children:"Skip the remaining of this chapter and return when you need to know more about contexts."})]}),"\n",(0,s.jsx)(t.p,{children:"The context also contains some other stuff:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:'The current `time. This allows you to keep your functions pure and still make the rules\ndependent on time (e.g. "reports can only be accessed during work hours"). Also, this makes it easy to unit test\nyour functions.'}),"\n",(0,s.jsxs)(t.li,{children:["A ",(0,s.jsx)(t.code,{children:"translator"}),": This is used by Klerk when it produces something that is human-readable, e.g. an error message."]}),"\n",(0,s.jsxs)(t.li,{children:["An ",(0,s.jsx)(t.code,{children:"auditExtra"}),": String where you can put other data that you want to be included in the audit log."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"You are free to put whatever else you want in the context."}),"\n",(0,s.jsx)(t.h2,{id:"actor",children:"Actor"}),"\n",(0,s.jsx)(t.p,{children:"The actor is one of these identities:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"ModelIdentity: Contains a full user model (see below)"}),"\n",(0,s.jsx)(t.li,{children:"ModelReferenceIdentity: Contains only a reference to a user model."}),"\n",(0,s.jsx)(t.li,{children:"CustomIdentity: Should be used when there is no User model describing the user. E.g. if authenticated via SSO, the user\ninformation is stored in an external system."}),"\n",(0,s.jsx)(t.li,{children:"Unauthenticated: Used to specify someone that we don't know who it is (yet)."}),"\n",(0,s.jsx)(t.li,{children:"AuthenticationIdentity: Used to read data needed when authenticating a user, since we cannot use the users identity\nuntil authentication is completed."}),"\n",(0,s.jsx)(t.li,{children:"SystemIdentity: Used by the system itself, bypassing all authorization rules. This should not be used often but may\nsometimes be needed, e.g. to create the first user in a system."}),"\n",(0,s.jsx)(t.li,{children:"PluginIdentity: Used by plugins."}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"systems-with-a-user-concept",children:"Systems with a 'User' concept"}),"\n",(0,s.jsx)(t.p,{children:"Most systems stores data about its users, i.e. there exists a User model. In these systems\nit is recommended to use ModelIdentity for logged-in users. For convenience, it is common to also put the model in the\ncontext so that we can easily access the user. It could look something like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"data class Ctx(\n    override val actor: ActorIdentity,\n    override val auditExtra: String? = null,\n    override val time: Instant = Clock.System.now(),\n    override val translator: Translator = DefaultTranslator(),\n    val user: Model<User>? = null,      // Klerk doesn't care about this\n) : KlerkContext\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Let's say the user makes an HTTP request to fetch a report and that a session cookie is\nincluded in the request. Using ",(0,s.jsx)(t.a,{href:"https://ktor.io/",children:"Ktor"}),", we would first create a function that uses the AuthenticationIdentity to create a ",(0,s.jsx)(t.code,{children:"Ctx"})," from an ",(0,s.jsx)(t.code,{children:"ApplicationCall"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"suspend fun ApplicationCall.context(): Ctx {\n    val userSession = call.sessions.get<UserSession>()\n    if (userSession == null) {\n        return Ctx(Unauthenticated)\n    }\n    val user = klerk.read(Ctx(AuthenticationIdentity)) {\n        getFirstWhere(collections.users.all) { it.props.sessionKey.string == userSession }\n    }\n    if (user == null) {\n        return Ctx(Unauthenticated)\n    }\n    return Ctx(actor = ModelIdentity(user), user = user)\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"We can now handle the request:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"val myReport = klerk.read(call.context()) { get(myReportId) }\n"})})]})}function u(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>a});var s=n(6540);const i={},o=s.createContext(i);function r(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);